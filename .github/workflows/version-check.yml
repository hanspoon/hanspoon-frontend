name: Version Check

on:
  pull_request:
    branches: [main]
    paths:
      - 'apps/extension/**'

jobs:
  check-version:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4

      - name: Check extension version bump
        run: |
          # PR 베이스 커밋(PR 생성 시점의 main)에서 버전 가져오기
          BASE_SHA=${{ github.event.pull_request.base.sha }}
          if git show ${BASE_SHA}:apps/extension/package.json > /tmp/base-package.json 2>/dev/null; then
            CURRENT=$(jq -r '.version' /tmp/base-package.json)
          else
            echo "베이스 커밋에 package.json이 없음 - 첫 릴리즈로 간주"
            CURRENT="0.0.0"
          fi

          # PR 브랜치의 새 버전
          NEW=$(jq -r '.version' apps/extension/package.json)

          echo "========================================"
          echo "현재 main 버전: $CURRENT"
          echo "PR 버전: $NEW"
          echo "========================================"

          if [ "$CURRENT" = "$NEW" ]; then
            echo ""
            echo "::error::버전이 변경되지 않았습니다!"
            echo ""
            echo "apps/extension/package.json의 version을 올려주세요."
            NEXT=$(echo "$CURRENT" | awk -F. '{print $1"."$2"."$3+1}')
            echo "예시: $CURRENT → $NEXT"
            exit 1
          fi

          echo ""
          echo "✅ 버전 변경 확인: $CURRENT → $NEW"
